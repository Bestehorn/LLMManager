{
  "enabled": true,
  "name": "Check Test Coverage",
  "description": "Manually trigger comprehensive test coverage analysis and improvement",
  "version": "1",
  "when": {
    "type": "manual"
  },
  "then": {
    "type": "askAgent",
    "prompt": "Analyze and improve test coverage:\n\n1. **Run Coverage Analysis**:\n   - Execute: venv\\Scripts\\activate & pytest test/ --cov=src/bestehorn_llmmanager --cov-report=term-missing --cov-report=html\n   - Note the current coverage percentage\n   - Identify which files and lines are not covered\n   - Open htmlcov/index.html in browser for detailed visual analysis (optional)\n\n2. **Check Coverage Target**:\n   - Read pyproject.toml [tool.pytest.ini_options] for coverage threshold\n   - Current target: 80% minimum (--cov-fail-under=80)\n   - Determine if current coverage meets the target\n   - If below target, calculate how much coverage needs to be added\n\n3. **Identify Coverage Gaps**:\n   - List all uncovered files and their coverage percentages\n   - Prioritize critical paths and core functionality that lack coverage:\n     * LLMManager.invoke() and invoke_with_retry() methods\n     * LLMManager streaming functionality\n     * MessageBuilder fluent interface methods (add_text, add_image, add_document, add_video)\n     * UnifiedModelManager model availability and fallback logic\n     * BedrockCatalog data fetching, caching, and transformation\n     * CacheManager cache operations\n     * APIFetcher AWS API interactions\n     * Error handling paths in all components\n     * Exception classes and their usage\n   - Identify edge cases and error handling paths that need testing:\n     * Empty inputs\n     * Invalid model IDs\n     * Network failures\n     * API throttling\n     * Cache misses and hits\n     * Malformed responses\n   - List specific functions/methods with line numbers that need coverage\n\n4. **Generate Missing Tests**:\n   - For each uncovered critical path, create appropriate tests\n   - Test file location rules:\n     * For src/bestehorn_llmmanager/x.py, create test/bestehorn_llmmanager/test_x.py\n     * For integration tests requiring AWS, use test/integration/\n   - Test types to create:\n     * Unit tests for core logic (mock external dependencies)\n     * Integration tests for AWS Bedrock interactions (test/integration/)\n     * Property-based tests using hypothesis for data validation\n     * Edge case tests for error conditions\n   - Use pytest fixtures for common setup (see test/conftest.py and test/integration/conftest.py)\n   - Follow existing test patterns in the codebase\n\n5. **Verify Improvement**:\n   - Re-run: venv\\Scripts\\activate & pytest test/ --cov=src/bestehorn_llmmanager --cov-report=term-missing --cov-fail-under=80\n   - Confirm coverage has increased\n   - Verify all new tests pass\n   - If coverage still below target, repeat steps 3-5\n   - Continue until coverage target is met (80%)\n\n6. **Run Quality Checks on New Tests**:\n   - Run: venv\\Scripts\\activate & black test/ --check --extend-exclude=\"src/bestehorn_llmmanager/_version.py\"\n   - Run: venv\\Scripts\\activate & isort test/ --check-only --skip=\"src/bestehorn_llmmanager/_version.py\"\n   - Run: venv\\Scripts\\activate & flake8 test/ --max-line-length=100 --extend-ignore=E203,W503\n   - Fix any formatting or linting issues in new test files\n\n7. **Report Results**:\n   - Initial coverage percentage (before improvements)\n   - Final coverage percentage (after improvements)\n   - Coverage increase (percentage points gained)\n   - List of test files created or modified (with file paths)\n   - Number of tests added (by category: unit, integration, property-based, edge cases)\n   - List of specific functions/methods that now have coverage\n   - Any remaining coverage gaps with justification:\n     * Why certain code is not covered (e.g., defensive code, deprecated paths)\n     * Whether gaps are acceptable or need future work\n   - Confirmation that coverage target (80%) is met or exceeded\n\n**Coverage Target**: 80% minimum for src/bestehorn_llmmanager/\n\n**Project-Specific Notes**:\n- Always exclude src/bestehorn_llmmanager/_version.py from coverage (it's auto-generated by setuptools-scm)\n- Line length is 100 characters (not 120) - project-specific setting\n- Use Windows activation command: venv\\Scripts\\activate\n- Package path for coverage: src/bestehorn_llmmanager\n- Integration tests requiring AWS Bedrock access go in test/integration/\n- Use hypothesis for property-based testing where applicable\n- Refer to test/conftest.py for shared fixtures\n- Refer to test/integration/conftest.py for AWS-specific fixtures\n\n**Focus Areas for Coverage**:\n1. Core LLMManager functionality (invoke, retry logic, streaming)\n2. MessageBuilder fluent interface\n3. Model management (UnifiedModelManager, ModelManager, CRISManager)\n4. Catalog system (BedrockCatalog, APIFetcher, CacheManager, BundledLoader, Transformer)\n5. Error handling and exception paths\n6. Edge cases and boundary conditions\n\n**CRITICAL**: Do not consider this task complete until coverage meets or exceeds 80% and all tests pass."
  }
}
